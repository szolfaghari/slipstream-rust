name: Build Windows Binaries
on: [workflow_dispatch, push]

jobs:
  build:
    runs-on: windows-latest

    steps:
      # ---------------- Checkout ----------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Ensure submodules are present
        shell: pwsh
        run: |
          git submodule update --init --recursive
          if (!(Test-Path "vendor/picoquic")) {
            throw "vendor/picoquic missing after submodule update"
          }

      # ---------------- Tooling ----------------
      - name: Install NASM
        uses: ilammy/setup-nasm@v1

      # ---------------- OpenSSL ----------------
      - name: Install OpenSSL via vcpkg
        shell: pwsh
        run: |
          vcpkg install openssl:x64-windows-static

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      # ---------------- Locate picotls ----------------
      - name: Locate picotls
        shell: pwsh
        run: |
          $root = Join-Path $env:GITHUB_WORKSPACE "vendor\picoquic"

          $ptls = Get-ChildItem -Path $root -Directory -Recurse |
            Where-Object { $_.Name -ieq "picotls" } |
            Select-Object -First 1

          if (-not $ptls) {
            throw "Could not find picotls directory inside vendor/picoquic"
          }

          "PTLS_DIR=$($ptls.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Found picotls at $($ptls.FullName)"

      # ---------------- Build picotls ----------------
      - name: Build picotls
        shell: pwsh
        run: |
          cd "$env:PTLS_DIR"
          if (!(Test-Path build)) { mkdir build }
          cd build

          cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded `
            -DOPENSSL_ROOT_DIR=C:/vcpkg/packages/openssl_x64-windows-static

          cmake --build . --config Release

      # ---------------- Build picoquic ----------------
      - name: Build picoquic
        shell: pwsh
        run: |
          $ptlsInclude = Join-Path $env:PTLS_DIR "include"
          $ptlsLibDir  = Join-Path $env:PTLS_DIR_
